---
name: integration-tests-admin-api
epic: admin-dashboard
status: open
priority: high
stream: D
depends_on: ["003"]
created: 2026-02-19T18:00:22Z
updated: 2026-02-19T18:00:22Z
---

# Task 006: Tests de integración — API routes de admin

## Objetivo

Cubrir los API endpoints de `/api/admin/*` con tests de integración que verifican autenticación, autorización y respuestas correctas.

## Tests a Crear

### `tests/integration/admin/leads-api.test.ts`

```typescript
describe('GET /api/admin/leads', () => {
  describe('Authentication', () => {
    it('returns 401 when no session cookie')
    it('returns 403 when authenticated as non-admin user (role: sales)')
    it('returns 403 when authenticated as non-admin user (role: developer)')
    it('returns 200 when authenticated as admin')
  })

  describe('Response shape', () => {
    it('returns array of leads in data field')
    it('returns total count in total field')
    it('returns page and limit in response')
    it('leads are ordered by created_at desc by default')
  })

  describe('Filtering', () => {
    it('filters by status=new correctly')
    it('filters by status=contacted correctly')
    it('filters by business_type=salon correctly')
    it('returns empty array when no matches')
  })

  describe('Pagination', () => {
    it('respects limit parameter')
    it('respects page parameter')
    it('returns correct slice of data')
  })
})

describe('GET /api/admin/leads/:id', () => {
  it('returns 401 without auth')
  it('returns 403 without admin role')
  it('returns 404 for non-existent lead')
  it('returns full lead data for valid id')
})
```

### `tests/integration/admin/analytics-api.test.ts`

```typescript
describe('GET /api/admin/analytics', () => {
  it('returns 401 without auth')
  it('returns 403 without admin role')
  it('returns analytics data with stats for admin')
  it('stats.total_visits is a number')
  it('stats.forms_submitted is a number')
  it('stats.conversion_rate is calculated correctly')
  it('filters by from and to date params')
})
```

### `tests/integration/admin/stats-api.test.ts`

```typescript
describe('GET /api/admin/stats', () => {
  it('returns 401 without auth')
  it('returns 403 without admin role')
  it('returns leads_total, leads_new, leads_this_week')
  it('returns conversion_rate as number')
  it('leads_new only counts status=new leads')
  it('leads_this_week counts only leads from last 7 days')
})
```

## Setup de Tests de Integración

Los tests de integración usan Supabase con datos de prueba. Crear `tests/integration/admin/setup.ts`:
- Crear usuario admin de prueba en Supabase test instance
- Crear usuario no-admin de prueba
- Insertar leads de prueba (5-10 registros)
- Insertar analytics de prueba
- Limpiar después de cada test suite

Usar `SUPABASE_SERVICE_ROLE_KEY` para el setup (solo en tests).

## Criterio Done
- [ ] `npm run test:integration` pasa todos los tests de admin
- [ ] 401 y 403 cubiertos en todos los endpoints
- [ ] Filtros y paginación verificados
- [ ] Tests son deterministas (no dependen de estado externo)
