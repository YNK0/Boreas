---
name: admin-api-routes
epic: admin-dashboard
status: open
priority: high
stream: C
depends_on: ["002"]
created: 2026-02-19T18:00:22Z
updated: 2026-02-19T18:00:22Z
---

# Task 003: API routes admin-protected para leads y analytics

## Objetivo

Crear los API endpoints que sirven datos al dashboard admin. Deben verificar sesión + rol admin antes de retornar cualquier dato.

## Archivos a Crear

### 1. `src/app/api/admin/leads/route.ts`

**GET /api/admin/leads**

Query params opcionales:
- `status` — filtrar por lead status
- `business_type` — filtrar por tipo de negocio
- `page` — paginación (default: 1)
- `limit` — items por página (default: 50)
- `order` — `asc` o `desc` por `created_at` (default: `desc`)

Response:
```json
{
  "data": [...leads],
  "total": 123,
  "page": 1,
  "limit": 50
}
```

Seguridad: Verificar usuario autenticado + `role = 'admin'` antes de hacer query.

### 2. `src/app/api/admin/leads/[id]/route.ts`

**GET /api/admin/leads/:id**

Retorna un lead específico con todos sus campos.

### 3. `src/app/api/admin/analytics/route.ts`

**GET /api/admin/analytics**

Query params:
- `from` — fecha inicio (ISO string)
- `to` — fecha fin (ISO string)
- `page`, `limit`

Response:
```json
{
  "data": [...landing_analytics],
  "stats": {
    "total_visits": 456,
    "forms_submitted": 23,
    "conversion_rate": 5.04,
    "unique_sources": ["google", "direct", "instagram"]
  },
  "total": 456
}
```

### 4. `src/app/api/admin/stats/route.ts`

**GET /api/admin/stats**

Stats para las cards del dashboard:
```json
{
  "leads_total": 45,
  "leads_new": 12,
  "leads_this_week": 8,
  "visits_total": 890,
  "conversion_rate": 5.06
}
```

## Helper de Auth para API Admin

Crear `src/lib/admin/verify-admin.ts`:
```typescript
export async function verifyAdminRequest(request: NextRequest) {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return { error: 'Unauthorized', status: 401 }

  const { data: profile } = await supabase.from('users').select('role').eq('id', user.id).single()
  if (profile?.role !== 'admin') return { error: 'Forbidden', status: 403 }

  return { user, supabase }
}
```

## Criterio Done
- [ ] `GET /api/admin/leads` retorna 401 sin sesión
- [ ] `GET /api/admin/leads` retorna 403 con sesión pero sin rol admin
- [ ] `GET /api/admin/leads` retorna leads con sesión admin
- [ ] `GET /api/admin/analytics` funciona igual
- [ ] `GET /api/admin/stats` retorna conteos correctos
- [ ] `npm run type-check` pasa
