---
name: admin-middleware-and-layout
epic: admin-dashboard
status: open
priority: critical
stream: B
depends_on: ["001"]
created: 2026-02-19T18:00:22Z
updated: 2026-02-19T18:00:22Z
---

# Task 002: Middleware de admin + Layout base de /admin

## Objetivo

Crear la infraestructura de seguridad para el panel `/admin`: middleware que verifica rol, layout con noindex, y login exclusivo de admins.

## Archivos a Crear/Modificar

### 1. `src/lib/supabase/middleware.ts` — Actualizar

Agregar protección de rutas `/admin/*` con verificación de rol:

```typescript
// Proteger rutas /admin
if (url.pathname.startsWith('/admin') && !url.pathname.startsWith('/admin/login')) {
  if (!user) {
    url.pathname = '/admin/login'
    return NextResponse.redirect(url)
  }
  // Verificar rol admin
  const { data: profile } = await supabase
    .from('users')
    .select('role')
    .eq('id', user.id)
    .single()

  if (profile?.role !== 'admin') {
    url.pathname = '/admin/unauthorized'
    return NextResponse.redirect(url)
  }
}

// Redirect authenticated admins desde /admin/login al dashboard
if (user && url.pathname === '/admin/login') {
  // Solo si es admin
  const { data: profile } = await supabase.from('users').select('role').eq('id', user.id).single()
  if (profile?.role === 'admin') {
    url.pathname = '/admin/dashboard'
    return NextResponse.redirect(url)
  }
}
```

**Importante:** La protección de `/dashboard` existente puede eliminarse o dejarse — el dashboard viejo ya no se usará.

### 2. `src/app/admin/layout.tsx` — Crear

Layout exclusivo para el panel admin:
- Meta tag `<meta name="robots" content="noindex, nofollow" />`
- Sin header ni footer del sitio público
- Fondo neutro (gray-100)
- Sin analytics de PostHog (o eventos separados)

### 3. `src/app/admin/page.tsx` — Crear

Solo un redirect a `/admin/dashboard`:
```typescript
import { redirect } from 'next/navigation'
export default function AdminRoot() {
  redirect('/admin/dashboard')
}
```

### 4. `src/app/admin/login/page.tsx` — Crear

Página de login simple y discreta:
- Formulario: email + password
- Sin enlace a "registrarse"
- Sin enlace visible al sitio público
- Al autenticar: verifica rol admin en tabla `users`
- Si no es admin: mensaje genérico "Credenciales incorrectas" (no revelar que existe el panel pero el rol es incorrecto)
- Usa `signInWithPassword` de Supabase client
- Redirige a `/admin/dashboard` si es admin

### 5. `src/app/admin/unauthorized/page.tsx` — Crear

Página simple de acceso denegado (para cuando alguien está autenticado pero no es admin). No revelar información sensible.

## Criterio Done
- [ ] `GET /admin` → redirect a `/admin/login` (si no autenticado)
- [ ] `GET /admin` → redirect a `/admin/dashboard` (si es admin)
- [ ] `GET /admin` → redirect a `/admin/unauthorized` (si autenticado pero no admin)
- [ ] `/admin/login` funciona con credenciales válidas de admin
- [ ] Todas las páginas de `/admin` tienen `noindex`
- [ ] `npm run type-check` pasa
