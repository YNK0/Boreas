---
name: e2e-tests-admin
epic: admin-dashboard
status: open
priority: medium
stream: D
depends_on: ["002", "003", "004"]
created: 2026-02-19T18:00:22Z
updated: 2026-02-19T18:00:22Z
---

# Task 007: Tests E2E — Flujo completo del admin

## Objetivo

Tests end-to-end con Playwright que verifican el flujo completo: acceso sin auth, login como admin, navegación del dashboard, y que el sitio público NO tiene links al admin.

## Tests a Crear

### `tests/e2e/admin-access-control.test.ts`

```typescript
describe('Admin Access Control', () => {
  test('redirects /admin to /admin/login when not authenticated', async ({ page }) => {
    await page.goto('/admin')
    await expect(page).toHaveURL('/admin/login')
  })

  test('redirects /admin/dashboard to /admin/login when not authenticated', async ({ page }) => {
    await page.goto('/admin/dashboard')
    await expect(page).toHaveURL('/admin/login')
  })

  test('shows unauthorized page for non-admin user', async ({ page }) => {
    // Login as non-admin user first
    // Then try to access /admin
    // Should see /admin/unauthorized
  })

  test('admin login form does not have register link', async ({ page }) => {
    await page.goto('/admin/login')
    await expect(page.locator('a[href="/auth/register"]')).not.toBeVisible()
    await expect(page.locator('a[href="/register"]')).not.toBeVisible()
  })

  test('admin pages have noindex meta tag', async ({ page }) => {
    await page.goto('/admin/login')
    const robots = await page.$eval('meta[name="robots"]', el => el.getAttribute('content'))
    expect(robots).toContain('noindex')
  })
})
```

### `tests/e2e/admin-login.test.ts`

```typescript
describe('Admin Login Flow', () => {
  test('shows error with invalid credentials', async ({ page }) => {
    await page.goto('/admin/login')
    await page.fill('input[type="email"]', 'wrong@example.com')
    await page.fill('input[type="password"]', 'wrongpassword')
    await page.click('button[type="submit"]')
    await expect(page.locator('[data-testid="error-message"]')).toBeVisible()
  })

  test('redirects to /admin/dashboard after successful admin login', async ({ page }) => {
    await page.goto('/admin/login')
    await page.fill('input[type="email"]', process.env.TEST_ADMIN_EMAIL!)
    await page.fill('input[type="password"]', process.env.TEST_ADMIN_PASSWORD!)
    await page.click('button[type="submit"]')
    await expect(page).toHaveURL('/admin/dashboard')
  })
})
```

### `tests/e2e/admin-dashboard.test.ts`

```typescript
describe('Admin Dashboard', () => {
  // Use stored auth state for admin (setup in beforeAll)

  test('shows stats cards on dashboard', async ({ page }) => {
    await page.goto('/admin/dashboard')
    await expect(page.locator('[data-testid="stat-leads-total"]')).toBeVisible()
    await expect(page.locator('[data-testid="stat-leads-new"]')).toBeVisible()
  })

  test('leads page shows table with headers', async ({ page }) => {
    await page.goto('/admin/dashboard/leads')
    await expect(page.locator('table')).toBeVisible()
    await expect(page.locator('th:has-text("Nombre")')).toBeVisible()
    await expect(page.locator('th:has-text("Email")')).toBeVisible()
    await expect(page.locator('th:has-text("Status")')).toBeVisible()
  })

  test('can filter leads by status', async ({ page }) => {
    await page.goto('/admin/dashboard/leads')
    await page.selectOption('[data-testid="filter-status"]', 'new')
    // Verify URL or results change
  })

  test('lead detail page shows all fields', async ({ page }) => {
    // Navigate to first lead's detail
    await page.goto('/admin/dashboard/leads')
    await page.locator('table tbody tr').first().click()
    await expect(page.locator('[data-testid="lead-email"]')).toBeVisible()
    await expect(page.locator('[data-testid="lead-business-type"]')).toBeVisible()
  })
})
```

### `tests/e2e/public-site-no-admin-links.test.ts`

```typescript
describe('Public site does not expose admin', () => {
  test('homepage has no link to /admin', async ({ page }) => {
    await page.goto('/')
    const adminLinks = page.locator('a[href*="/admin"]')
    await expect(adminLinks).toHaveCount(0)
  })

  test('homepage has no link to /dashboard', async ({ page }) => {
    await page.goto('/')
    const dashboardLinks = page.locator('a[href*="/dashboard"]')
    await expect(dashboardLinks).toHaveCount(0)
  })

  test('homepage has no login/register buttons', async ({ page }) => {
    await page.goto('/')
    const loginLinks = page.locator('a[href*="/auth/login"], a[href*="/login"], a[href*="/register"]')
    await expect(loginLinks).toHaveCount(0)
  })

  test('header has no dashboard CTA button', async ({ page }) => {
    await page.goto('/')
    await expect(page.locator('[data-testid="dashboard-cta"]')).toHaveCount(0)
  })
})
```

## Variables de Entorno Necesarias

Agregar a `.env.test`:
```
TEST_ADMIN_EMAIL=admin@test.com
TEST_ADMIN_PASSWORD=testpassword123
```

## Criterio Done
- [ ] `npm run test:e2e` pasa todos los tests de admin
- [ ] Access control verificado (401/redirect sin auth)
- [ ] Login flow completo funciona
- [ ] Sitio público limpio (sin links a admin/dashboard/login)
- [ ] Stats cards visibles tras login
- [ ] Tabla de leads y detalle verificados
