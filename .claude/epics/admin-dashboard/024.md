---
name: middleware-and-public-auth-cleanup
epic: admin-dashboard
status: open
priority: medium
stream: B
depends_on: ["001", "002"]
created: 2026-02-19T18:00:22Z
updated: 2026-02-19T18:00:22Z
---

# Task 008: Cleanup final — middleware y rutas de auth públicas

## Objetivo

Después de que el admin esté en `/admin`, limpiar el middleware y decidir qué pasa con las rutas de auth públicas (`/auth/login`, `/auth/register`, `/auth/confirmed`, etc.) que ya no deben ser accesibles desde el sitio público.

## Cambios en `src/lib/supabase/middleware.ts`

1. **Remover** protección de `/dashboard` (ya no existe o redirige a /admin)
2. **Remover** redirect de usuarios autenticados desde `/auth/*` hacia `/dashboard`
3. Las rutas `/auth/*` pueden quedar sin protección especial (no se acceden desde el sitio)
4. Agregar comentario explicando que `/admin` tiene su propia protección

Middleware final simplificado:
```typescript
// Solo protege /admin con verificación de rol
// Las rutas de auth públicas quedan sin redirect automático
// El sitio público no tiene ningún botón/link a auth o admin
```

## Archivos de auth que quedan "huérfanos"

Las páginas en `src/app/auth/` (`login/`, `register/`, `confirmed/`, `confirm-email/`) quedan en el codebase pero sin links públicos. Decisiones:

**Opción A (Recomendada):** Dejarlas como están pero sin links públicos. El admin puede ir directo a `/admin/login` que tiene su propio form.

**Opción B:** Moverlas también a `/admin/auth/` para claridad.

**Decisión:** Implementar Opción A (menos cambios, misma seguridad práctica).

## Verificación Final

```bash
# 1. Verificar que no hay links a auth en sitio público
grep -rn '/auth/login\|/auth/register\|/login\|/register' src/app/page.tsx src/components/landing/ src/components/common/header.tsx

# 2. Verificar que /admin/dashboard redirecciona sin auth
# (manual: abrir browser en modo incógnito, ir a /admin/dashboard)

# 3. Verificar noindex en /admin
# (manual: ver source de /admin/login)

# 4. Verificar que header no tiene botones de login
# (visual + grep)
```

## Criterio Done
- [ ] Middleware limpio y comentado
- [ ] No hay redirects de auth que lleven a `/dashboard` (ya no existe)
- [ ] `/admin/*` correctamente protegido con rol check
- [ ] `npm run type-check && npm run lint` pasan
- [ ] Build de producción sin warnings de rutas obsoletas
