---
name: tests-actualizar-post-fix
epic: admin-auth-fix
stream: D
status: open
priority: medium
blockedBy: [003, 004, 005]
created: 2026-02-20T06:08:48Z
updated: 2026-02-20T06:08:48Z
---

# Task 007: Tests — Actualizar suite post-fix

## Objetivo

Actualizar los tests existentes para reflejar el nuevo comportamiento (503 en DB error, error explícito del middleware) y agregar casos que antes faltaban.

## Cambios en tests unitarios — `verify-admin.test.ts`

### Añadir caso: error de DB retorna 503
```typescript
it('returns 503 when DB query throws an error', async () => {
  mockGetUser.mockResolvedValue({ data: { user: { id: 'user-1' } } })
  // Simular error de Supabase (PGRST116, conexión rota, etc.)
  mockFrom.mockReturnValue({
    select: jest.fn().mockReturnThis(),
    eq: jest.fn().mockReturnThis(),
    single: jest.fn().mockResolvedValue({
      data: null,
      error: { message: 'connection timeout', code: 'PGRST301' }
    }),
  })

  const result = await verifyAdmin()

  expect(result.error).toBe('Service Unavailable')
  expect(result.status).toBe(503)
})
```

## Cambios en tests de integración

### `tests/integration/api/admin/leads.test.ts`
Añadir caso donde `verifyAdmin` retorna 503:
```typescript
it('returns 503 when DB is unavailable', async () => {
  mockVerifyAdmin.mockResolvedValue({ error: 'Service Unavailable', status: 503 } as any)
  const res = await GET(makeRequest('http://localhost/api/admin/leads'))
  expect(res.status).toBe(503)
  const body = await res.json()
  expect(body.error).toBe('Service Unavailable')
})
```
Añadir el mismo caso en `leads-id.test.ts`, `stats.test.ts`, `analytics.test.ts`.

## Cambios en tests E2E — `admin-access-control.test.ts`

### Añadir guía de configuración como comentario
```typescript
/**
 * Para habilitar la suite "Authenticated admin dashboard":
 *
 * 1. Crear usuario admin en Supabase Dashboard:
 *    Authentication → Users → Add user
 *    Email: admin@boreas.mx | Auto confirm: ✅
 *
 * 2. Insertar en public.users:
 *    INSERT INTO public.users (id, role) VALUES ('<uuid>', 'admin');
 *
 * 3. Configurar en .env.test.local o antes de ejecutar:
 *    ADMIN_TEST_EMAIL=admin@boreas.mx
 *    ADMIN_TEST_PASSWORD=<contraseña>
 *
 * 4. Ejecutar:
 *    ADMIN_TEST_EMAIL=... ADMIN_TEST_PASSWORD=... npx playwright test admin-access-control
 */
```

### Mejorar el selector del botón de submit en login
El test actual usa:
```typescript
page.getByRole('button').filter({ hasText: /entrar|iniciar|acceder|ingresar/i })
```
El botón real dice "Entrar" — verificar que el selector funciona y ajustar si es necesario.

## Ejecutar todos los tests

```bash
# Unit + Integration (debe dar 88+ passing)
npx jest --no-coverage

# E2E (sin credenciales — skips la suite autenticada)
npx playwright test tests/e2e/admin-access-control.test.ts --project=chromium

# E2E con credenciales (si están configuradas)
ADMIN_TEST_EMAIL=admin@boreas.mx ADMIN_TEST_PASSWORD=xxx \
  npx playwright test tests/e2e/admin-access-control.test.ts --project=chromium
```

## Archivos a modificar
- `src/lib/admin/verify-admin.test.ts`
- `tests/integration/api/admin/leads.test.ts`
- `tests/integration/api/admin/leads-id.test.ts`
- `tests/integration/api/admin/stats.test.ts`
- `tests/integration/api/admin/analytics.test.ts`
- `tests/e2e/admin-access-control.test.ts` (comentarios + selector fix)

## Criterio Done
- [ ] `verify-admin.test.ts` tiene caso para 503 (DB error)
- [ ] Cada test de integración tiene caso para 503 propagado desde verifyAdmin
- [ ] `admin-access-control.test.ts` tiene guía de configuración clara
- [ ] `npx jest --no-coverage` pasa con 88+ tests
- [ ] E2E tests pasan (sin credenciales: 12/17 tests, skipping suite autenticada)
