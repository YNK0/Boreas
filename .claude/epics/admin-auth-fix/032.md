---
name: fix-middleware-fail-safe
epic: admin-auth-fix
stream: B
status: open
priority: high
blockedBy: [001]
blocks: [006, 007]
created: 2026-02-20T06:08:48Z
updated: 2026-02-20T06:08:48Z
---

# Task 003: Fix — Middleware fail-safe + logging de diagnóstico

## Objetivo

Hacer el middleware estrictamente seguro: cualquier error en el query de roles resulta en acceso denegado, nunca en acceso concedido.

## Cambios en `src/lib/supabase/middleware.ts`

### Problema actual
```typescript
// ❌ Solo destructura `data`, ignora `error`
const { data: profile } = await supabase
  .from('users').select('role').eq('id', user.id).single()

if (profile?.role !== 'admin') {
  // Correcto si profile es null por no existir el registro
  // PERO: si hay un error de DB, profile también es null → redirige
  // El problema es que no sabemos si redirigió por error o por design
}
```

### Fix requerido
```typescript
// ✅ Destructurar también `error`
const { data: profile, error: profileError } = await supabase
  .from('users')
  .select('role')
  .eq('id', user.id)
  .single()

if (profileError) {
  if (process.env.NODE_ENV === 'development') {
    console.error('[Admin Middleware] DB error en role check:', profileError.message, profileError.code)
  }
  url.pathname = '/admin/unauthorized'
  return NextResponse.redirect(url)
}

if (!profile || profile.role !== 'admin') {
  url.pathname = '/admin/unauthorized'
  return NextResponse.redirect(url)
}
```

### Mismo fix para el bloque de redirect desde login
```typescript
// Bloque: "Admin already logged in → redirect away from login"
const { data: profile, error: profileError } = await supabase
  .from('users').select('role').eq('id', user.id).single()

// Solo redirigir si CONFIRMA que es admin (no si hay error)
if (!profileError && profile?.role === 'admin') {
  url.pathname = '/admin/dashboard'
  return NextResponse.redirect(url)
}
```

### Logging temporal de diagnóstico (remover en producción)
```typescript
// Al inicio de updateSession, solo en dev:
if (process.env.NODE_ENV === 'development') {
  console.log('[Middleware] →', url.pathname)
}
```

## Verificación
1. Sin sesión → navegar a `/admin/dashboard` → debe redirigir a `/admin/login`
2. Con sesión de usuario no-admin → debe redirigir a `/admin/unauthorized`
3. Con sesión de admin → debe pasar al dashboard
4. Con Supabase URL incorrecta (simular error) → debe redirigir a `/admin/unauthorized`, nunca pasar

## Archivos a modificar
- `src/lib/supabase/middleware.ts`

## Criterio Done
- [ ] `error` del query de roles se destructura explícitamente
- [ ] Error de DB redirige a `/admin/unauthorized` (nunca pass-through)
- [ ] Log en dev muestra pathname y user id en cada request admin
- [ ] Verificación manual: sin sesión → login, con sesión non-admin → unauthorized, con admin → dashboard
