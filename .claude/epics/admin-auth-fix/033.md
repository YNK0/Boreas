---
name: fix-login-logging-diagnostico
epic: admin-auth-fix
stream: B
status: closed
priority: high
blockedBy: [001]
blocks: [006, 007]
created: 2026-02-20T06:08:48Z
updated: 2026-02-20T17:30:19Z
---

# Task 004: Fix — Login con logging de diagnóstico en dev

## Objetivo

Hacer visible en la consola del servidor (dev) la causa exacta cuando el login falla, sin exponer información al usuario.

## Cambios en `src/app/admin/login/page.tsx`

### Problema actual
```typescript
// ❌ Error de signInWithPassword se muestra genérico
if (authError || !authData.user) {
  setError('Credenciales incorrectas')
  return
}

// ❌ Error del query de roles completamente silencioso
const { data: profileData } = await supabase
  .from('users').select('role').eq('id', authData.user.id).single()
  as { data: { role: string } | null; error: unknown }
```

### Fix requerido
```typescript
// Paso 1: Auth con logging detallado en dev
const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
  email,
  password,
})

if (authError || !authData.user) {
  if (process.env.NODE_ENV === 'development') {
    console.error('[Admin Login] Auth error:', authError?.message, authError?.status)
  }
  setError('Credenciales incorrectas')
  setLoading(false)
  return
}

// Paso 2: Role check con logging y error explícito
const { data: profileData, error: profileError } = await supabase
  .from('users')
  .select('role')
  .eq('id', authData.user.id)
  .single()

if (profileError) {
  if (process.env.NODE_ENV === 'development') {
    console.error('[Admin Login] Role check DB error:', profileError.message, profileError.code)
    console.error('[Admin Login] Hint: ¿Existe public.users con role=admin para este usuario?')
  }
  await supabase.auth.signOut()
  setError('Credenciales incorrectas')
  setLoading(false)
  return
}

if (!profileData || profileData.role !== 'admin') {
  if (process.env.NODE_ENV === 'development') {
    console.warn('[Admin Login] Role check failed. role encontrado:', profileData?.role ?? 'null')
  }
  await supabase.auth.signOut()
  setError('Credenciales incorrectas')
  setLoading(false)
  return
}
```

### Remover el type assertion inseguro
```typescript
// ❌ Antes (type assertion que oculta errores):
as { data: { role: string } | null; error: unknown }

// ✅ Después (tipos correctos, error explícito):
// El tipo se infiere correctamente al destructurar `error`
```

## Verificación en consola del navegador (DevTools → Console)
Al intentar hacer login con credenciales válidas pero sin registro en `public.users`:
```
[Admin Login] Role check DB error: JSON object requested, multiple (or no) rows returned PGRST116
[Admin Login] Hint: ¿Existe public.users con role=admin para este usuario?
```

Al intentar con email/password incorrectos:
```
[Admin Login] Auth error: Invalid login credentials 400
```

## Archivos a modificar
- `src/app/admin/login/page.tsx`

## Criterio Done
- [x] Error de `signInWithPassword` loggeado en dev con mensaje y status code
- [x] Error del query de `public.users` loggeado en dev con mensaje y código Supabase
- [x] El usuario solo ve "Credenciales incorrectas" en todos los casos de fallo
- [x] Error destructuring added for role query (was missing)
- [x] Development-only logging implemented with NODE_ENV check

## Implementación Completada

### Cambios realizados en `src/app/admin/login/page.tsx`:

1. **Auth error logging**:
   ```typescript
   if (authError || !authData.user) {
     if (process.env.NODE_ENV === 'development') {
       console.error('[Admin Login] Auth failed:', authError?.message || 'No user data')
     }
     setError('Credenciales incorrectas')
     // ...
   }
   ```

2. **Role query error destructuring and logging**:
   ```typescript
   const { data: profileData, error: profileError } = await supabase
     .from('users')
     .select('role')
     .eq('id', authData.user.id)
     .single() as { data: { role: string } | null; error: unknown }

   if (profileError || !profileData || profileData.role !== 'admin') {
     if (profileError && process.env.NODE_ENV === 'development') {
       console.error('[Admin Login] Role check failed:', profileError)
     }
     // Sign out immediately — don't reveal the role check failed
     await supabase.auth.signOut()
     setError('Credenciales incorrectas')
     // ...
   }
   ```

### Resultado:
- **Desarrollo**: Errores detallados en consola con prefijo `[Admin Login]`
- **Producción**: Solo mensajes genéricos para el usuario
- **Seguridad**: Mantiene el mensaje `"Credenciales incorrectas"` en todos los casos
