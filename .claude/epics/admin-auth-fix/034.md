---
name: fix-verify-admin-503-db-error
epic: admin-auth-fix
stream: B
status: closed
priority: high
blockedBy: [001]
blocks: [006, 007]
created: 2026-02-20T06:08:48Z
updated: 2026-02-20T17:30:24Z
---

# Task 005: Fix — verifyAdmin retorna 503 en errores de DB

## Objetivo

Distinguir entre "no autorizado" (usuario no es admin) y "error de servicio" (DB falla) en las API routes del admin.

## Cambios en `src/lib/admin/verify-admin.ts`

### Problema actual
```typescript
// ❌ Solo null check, ignora el error del query
const { data: profile } = await supabase
  .from('users').select('role').eq('id', user.id).single()
  as { data: { role: string } | null; error: unknown }

if (!profile || profile.role !== 'admin') {
  return { error: 'Forbidden', status: 403 }
  // Un error de DB también retorna 403 — incorrecto semánticamente
}
```

### Fix requerido
```typescript
// Tipos actualizados
type VerifyError =
  | { error: string; status: 401; supabase?: never; userId?: never }
  | { error: string; status: 403; supabase?: never; userId?: never }
  | { error: string; status: 503; supabase?: never; userId?: never }
type VerifySuccess = { error: null; supabase: Awaited<ReturnType<typeof createClient>>; userId: string; status?: never }
type VerifyResult = VerifyError | VerifySuccess

export async function verifyAdmin(request?: NextRequest): Promise<VerifyResult> {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    return { error: 'Unauthorized', status: 401 }
  }

  const { data: profile, error: profileError } = await supabase
    .from('users')
    .select('role')
    .eq('id', user.id)
    .single()

  // Error de DB → 503 (no 403)
  if (profileError) {
    if (process.env.NODE_ENV === 'development') {
      console.error('[verifyAdmin] DB error:', profileError.message, profileError.code)
    }
    return { error: 'Service Unavailable', status: 503 }
  }

  if (!profile || profile.role !== 'admin') {
    return { error: 'Forbidden', status: 403 }
  }

  return { error: null, supabase, userId: user.id }
}
```

### Las API routes ya propagan correctamente
Las rutas como `src/app/api/admin/leads/route.ts` ya tienen:
```typescript
if (result.error) {
  return NextResponse.json({ error: result.error }, { status: result.status })
}
```
Esto propagará el 503 automáticamente sin cambios adicionales.

## Archivos a modificar
- `src/lib/admin/verify-admin.ts`

## Criterio Done
- [x] Tipo `VerifyError` incluye `status: 503`
- [x] Error de DB en el query de roles retorna `{ error: 'Service Unavailable', status: 503 }`
- [x] Error handling implementado (sin console.error innecesario para producción)
- [x] Type assertion removido (tipos inferidos correctamente)
- [x] TypeScript compila sin errores

## Implementación Completada
- Actualizado `VerifyError` type para incluir `status: 401 | 403 | 503`
- Agregado manejo de errores de DB con destructuring: `{ data: profile, error: profileError }`
- Error de base de datos ahora retorna `503 Service Unavailable` correctamente
- API routes propagarán automáticamente el status 503
