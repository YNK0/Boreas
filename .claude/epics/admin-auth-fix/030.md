---
name: diagnóstico-env-middleware-schema
epic: admin-auth-fix
stream: A
status: completed
priority: critical
blocks: [002, 003, 004, 005]
created: 2026-02-20T06:08:48Z
updated: 2026-02-20T17:22:39Z
---

# Task 001: Diagnóstico — env vars, middleware y schema Supabase

## Objetivo

Identificar con precisión la causa raíz de los tres fallos antes de escribir código. Documentar hallazgos.

## Pasos

### 1. Verificar `.env.local`
```bash
# Verificar que existe y tiene las variables
cat .env.local | grep SUPABASE
```
- ¿Existe `.env.local`?
- ¿`NEXT_PUBLIC_SUPABASE_URL` tiene el valor correcto (formato: `https://<ref>.supabase.co`)?
- ¿`NEXT_PUBLIC_SUPABASE_ANON_KEY` tiene el anon key del proyecto?

### 2. Verificar que el middleware se ejecuta
Añadir temporalmente en `src/lib/supabase/middleware.ts`:
```typescript
console.log('[Middleware] pathname:', url.pathname)
console.log('[Middleware] user:', user?.id ?? 'null')
```
Navegar a `/admin/dashboard` y revisar la terminal del servidor Next.js.

### 3. Auditar el flujo del middleware
Leer `src/lib/supabase/middleware.ts` completo y verificar:
- ¿Se destructura `error` del query de `public.users`?
- ¿Si `profile` es null, redirige o pasa?
- ¿El `matcher` en `middleware.ts` raíz incluye `/admin/:path*`?

### 4. Verificar schema en Supabase Dashboard
Conectarse al proyecto Supabase y verificar:
- [ ] Tabla `public.users` existe
- [ ] Columna `role TEXT` existe en `public.users`
- [ ] Existe al menos un registro con `role = 'admin'`
- [ ] RLS está habilitado en `public.users`
- [ ] Existe política que permite `SELECT` cuando `auth.uid() = id`

### 5. Verificar usuario admin
```sql
-- Ejecutar en Supabase SQL Editor
SELECT au.id, au.email, pu.role
FROM auth.users au
LEFT JOIN public.users pu ON au.id = pu.id
WHERE pu.role = 'admin' OR au.email LIKE '%admin%';
```

### 6. Documentar hallazgos
Crear `.claude/epics/admin-auth-fix/diagnostico.md` con:
- Estado de cada variable de entorno (sin revelar valores)
- Si el middleware se ejecuta y qué retorna
- Si existe la tabla `public.users` y el usuario admin
- Causa raíz confirmada de cada fallo

## Archivos a leer (no modificar)
- `.env.local`
- `middleware.ts` (raíz)
- `src/lib/supabase/middleware.ts`
- Supabase Dashboard (externo)

## Criterio Done
- [ ] `.env.local` verificado
- [ ] Middleware confirmado que se ejecuta (logs en terminal)
- [ ] Causa raíz de Fallo 1 (acceso sin auth) identificada
- [ ] Causa raíz de Fallo 2 (login falla) identificada
- [ ] Archivo `diagnostico.md` creado con hallazgos
