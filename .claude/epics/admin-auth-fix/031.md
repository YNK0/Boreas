---
name: supabase-migration-admin-user-setup
epic: admin-auth-fix
stream: A
status: completed
priority: critical
blockedBy: [001]
blocks: [003, 004, 005, 006]
created: 2026-02-20T06:08:48Z
updated: 2026-02-20T17:26:35Z
---

# Task 002: Supabase — Migration SQL + Setup usuario admin

## Objetivo

Garantizar que el schema de Supabase está correcto y que existe un usuario admin funcional.

## Migration SQL

Crear `supabase/migrations/20260220_users_role.sql`:

```sql
-- Crear tabla public.users si no existe
CREATE TABLE IF NOT EXISTS public.users (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  role TEXT NOT NULL DEFAULT 'user',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Habilitar RLS
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;

-- Política: usuario puede leer su propio registro
CREATE POLICY IF NOT EXISTS "users_read_own"
  ON public.users
  FOR SELECT
  USING (auth.uid() = id);

-- Política: service role puede leer todos (para el middleware)
CREATE POLICY IF NOT EXISTS "service_role_read_all"
  ON public.users
  FOR SELECT
  TO service_role
  USING (true);

-- Trigger: crear registro en public.users al registrar en auth
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.users (id, role)
  VALUES (new.id, 'user')
  ON CONFLICT (id) DO NOTHING;
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```

## Instrucciones para aplicar

### Opción A — Supabase CLI (si está instalado)
```bash
supabase db push
```

### Opción B — SQL Editor en Dashboard
1. Ir a Supabase Dashboard → SQL Editor
2. Pegar el SQL de la migration
3. Ejecutar

## Crear usuario admin

### Paso 1: Crear usuario en Supabase Auth
En el Dashboard: Authentication → Users → Add user
- Email: `admin@boreas.mx` (o el email deseado)
- Password: contraseña segura
- Auto confirm: ✅

### Paso 2: Obtener el UUID del usuario
```sql
SELECT id FROM auth.users WHERE email = 'admin@boreas.mx';
```

### Paso 3: Insertar/actualizar en public.users con role admin
```sql
INSERT INTO public.users (id, role)
VALUES ('<uuid-del-paso-2>', 'admin')
ON CONFLICT (id) DO UPDATE SET role = 'admin';
```

### Paso 4: Verificar
```sql
SELECT au.email, pu.role
FROM auth.users au
JOIN public.users pu ON au.id = pu.id
WHERE pu.role = 'admin';
```

## Documentación

Crear `docs/guides/admin-user-setup.md` con instrucciones completas para futuras referencias.

## Archivos a crear/modificar
- `supabase/migrations/20260220_users_role.sql` (nuevo)
- `docs/guides/admin-user-setup.md` (nuevo)

## Criterio Done
- [x] Migration file created: `supabase/migrations/20260220_users_role.sql`
- [x] Complete admin setup guide created: `docs/guides/admin-user-setup.md`
- [x] Instructions provided for both CLI and Dashboard methods
- [x] Verification queries included in documentation
- [ ] Migration SQL aplicada en Supabase (manual step - requires Dashboard access)
- [ ] Usuario admin existe en `auth.users` Y en `public.users` con `role='admin'` (manual step)
- [ ] Query de verificación retorna el usuario admin correctamente (manual step)

**Status:** Files and documentation completed ✅
**Next:** Manual application of migration and admin user creation (requires Supabase Dashboard access)
